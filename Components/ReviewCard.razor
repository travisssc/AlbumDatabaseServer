@using AlbumDatabaseServer.Data
@inject UserService UserService
@inject AlbumService AlbumService
@inject GenreService GenreService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="review-container @(width == "profile" ? "profile" : "")">
	<div class="album-cover">
		<AlbumComponent album="@album" displayInfo="false" />
	</div>
	<div class="review-content">
		<div class="album-info">
			<div class="album-name-year">
				<h2 class="album-name" @onclick="() => HandleNavigation(album, 0)">@album.Name</h2>
				<h3 class="album-year">@album.ReleaseDate.ToString("yyyy")</h3>
			</div>
			<h3 class="album-artist" @onclick="() => HandleNavigation(album, 1)">@album.Artist.ArtistName</h3>
			<div class="user-info-container">
				<div class="star-container">
					@if (albumRating != null)
					{
						@for (int i = 0; i < albumRating; i++)
						{
							<span class="material-symbols-outlined star">
								star
							</span>
						}
					}
				</div>
				@if (isFavorited)
				{
					<span class="material-symbols-outlined favorite">
						favorite
					</span>
				}
				<h4 class="listened-text">Listened @dateListened.ToString("dd MMMM yyyy")</h4>
			</div>
			<div class="review-text">
				<h3>@reviewText</h3>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public Album album { get; set; }
	[Parameter] public string width { get; set; }
	[Parameter] public string userName { get; set; }
	private int albumRating;
	private bool isFavorited;
	private DateTime dateListened;
	private string reviewText;
	 
	protected override async Task OnParametersSetAsync()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		if (album != null)
		{
			albumRating = await UserService.GetRatingIntAsync(album.AlbumId, userName);
			isFavorited = await UserService.IsAlbumFavoritedAsync(album.AlbumId, userName);
			dateListened = await UserService.GetDateListenedAsync(userName, album.AlbumId);
			var review = await UserService.GetReviewAsync(album.AlbumId, userName);
			reviewText = review.ReviewText;
		}
	}
	private void HandleNavigation(Album album, int type)
	{
		if (type == 0)
		{
			var encodedArtistName = Uri.EscapeDataString(album.Artist.ArtistName);
			var encodedAlbumName = Uri.EscapeDataString(album.Name);
			NavigationManager.NavigateTo($"/albums/{encodedArtistName}/{encodedAlbumName}");
		}
		else
		{
			var encodedArtistName = Uri.EscapeDataString(album.Artist.ArtistName);
			NavigationManager.NavigateTo($"/artists/{encodedArtistName}?artistId={album.ArtistId}");
		}

	}

}
